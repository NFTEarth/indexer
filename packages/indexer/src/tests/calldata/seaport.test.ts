import { config as dotEnvConfig } from "dotenv";
dotEnvConfig();
import { config } from "@/config/index";
import { Seaport } from "@nftearth/sdk";
import { keccak256 } from "ethers/lib/utils";
import { toUtf8Bytes } from "@ethersproject/strings";
import { BigNumber } from "ethers";
import { padSourceToSalt } from "@/orderbook/orders/seaport/build/utils";

jest.setTimeout(1000 * 1000);

export const generateSourceBytes = (source?: string) => {
  return source ? keccak256(toUtf8Bytes(source)).slice(2, 10) : "";
};

describe("CallData - Seaport", () => {
  it("parseOrder", async () => {
    const exchange = new Seaport.Exchange(config.chainId);
    const inputData =
      "0xfb0f3ee10000000000000000000000000000000000000000000000000000000000000020000000000000000000000000420000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a5e27eef13e0000000000000000000000000000d131f1bcdd547e067af447dd3c36c99d6be9fdeb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099030c3f880a468ed74806fb2785afd2da54a2f40000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000063d8c50a0000000000000000000000000000000000000000000000000000000063fdaf4600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a8f071673eeb1a961450475cbff07c7f9a52cd0b087e113152324fca962488b4d9beb6f4caf6f100000000000000000000f1cd0b087e113152324fca962488b4d9beb6f4caf6f100000000000000000000f10000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000b1a2bc2ec5000000000000000000000000000078ed254b9c140c1a2be10d2ad32c65b5f712f54b00000000000000000000000000000000000000000000000000b1a2bc2ec5000000000000000000000000000078ed254b9c140c1a2be10d2ad32c65b5f712f54b0000000000000000000000000000000000000000000000000000000000000041fd47ab08fd565df9d33cc27c435d9fa7690a04c6ee7279bbed6ab7f80e83f32b2cb2e1da2cef364f2f847af64e2bc15f0eb715885662fe12b0a822247acee6681c00000000000000000000000000000000000000000000000000000000000000a8f07167";
    const args = exchange.contract.interface.decodeFunctionData("fulfillBasicOrder", inputData);
    const orderSourceHash = args.parameters.salt._hex.slice(2, 10);

    const openseaHash = "a8f07167";
    const source = "nftearth.exchange";
    const sourceHash = generateSourceBytes(source);

    const salt = "1234";
    const saltSource = padSourceToSalt(source, salt);
    const saltWithSource = BigNumber.from(saltSource)._hex;

    expect(saltWithSource.slice(2, 10)).toBe(openseaHash);
    expect(sourceHash).toBe(openseaHash);
    expect(orderSourceHash).toBe(openseaHash);
  });
});
